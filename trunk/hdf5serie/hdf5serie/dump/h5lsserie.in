#! /bin/sh
#
# Unix sh variant of h5lsserie (h5lsserie.in)
# If editing this file, also edit the file h5lsserie.bat.in
#
# Copyright (C) 2009 Markus Friedrich
#
# This library is free software; you can redistribute it and/or 
# modify it under the terms of the GNU Lesser General Public 
# License as published by the Free Software Foundation; either 
# version 2.1 of the License, or (at your option) any later version. 
#  
# This library is distributed in the hope that it will be useful, 
# but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU 
# Lesser General Public License for more details. 
#  
# You should have received a copy of the GNU Lesser General Public 
# License along with this library; if not, write to the Free Software 
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301 USA
#
# Contact:
#   mafriedrich@users.berlios.de
#

H=0 # option -h, --help: help
D=0 # option -d: show description
L=0 # optoin -l: show Column/Member Label
F=0 # option -f: follow external links
while test $# -ne 0; do
  case $1 in
    -d)        D=1;;
    -h|--help) H=1;;
    -l)        L=1;;
    -f)        F=1;;
    -*)        echo "Invalid option: $1; see output of h5lsserie"
               exit 1;;
    *)         FILE=$1;;
  esac
  shift
done

if [ $H -eq 1 ]; then
  echo "h5lsserie"
  echo ""
  echo "Lists the groups and datasets in a hdf5 file."
  echo ""
  echo "Copyright (C) 2009 Markus Friedrich <mafriedrich@users.berlios.de>"
  echo "This is free software; see the source for copying conditions. There is NO"
  echo "warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
  echo ""
  echo "Licensed under the GNU Lesser General Public License (LGPL)"
  echo ""
  echo "Usage:"
  echo "  h5lsserie [-d] [-l] <file.h5>"
  echo "    -h, --help: Show this help"
  echo "    -d:         Show 'Description' attribute"
  echo "    -l:         Show 'Column/Member Label'"
  echo "    -f:         Follow external links"
  exit 0
fi

prefix=@prefix@
datadir=@datadir@


# check for pid file and send SIGUSR2 if found
DIR=$(dirname $FILE)
cd $DIR
SIGNALSEND=false
for SUBFILE in *.h5 $FILE; do
  kill -USR2 $(cat .$SUBFILE.pid 2> /dev/null) >& /dev/null && SIGNALSEND=true
done
test $SIGNALSEND = "true" && sleep 1


# create XML dump (without data) of all *.h5 files in the
# directory of file FILE (save as .*.h5.xml)
DIR=$(dirname $FILE)
cd $DIR
for SUBFILE in *.h5 $FILE; do
  @h5dump@ -xA $SUBFILE > .$SUBFILE.xml
done

# call xslt
if [ @xsltproc@ != "no" ]; then
  @xsltproc@ --path . --param FILENAME "'$FILE'" --param LABEL $L --param DESCRIPTION $D --param FOLLOW $F $datadir/hdf5serie/xsl/h5lsserie.xsl .$(basename $FILE).xml
elif [ @msxsl@ != "no" ]; then
  @msxsl@ .$(basename $FILE).xml $datadir/hdf5serie/xsl/h5lsserie.xsl FILENAME="$FILE" LABEL=$L DESCRIPTION=$D FOLLOW=$F
fi

# delete all previous created .*.h5.xml files
for SUBFILE in *.h5 $FILE; do
  rm -f .$SUBFILE.xml
done
